let%expect_test "sample" =
  let open! Aoc_std in
  let open Solution in
  run
  @@ fun _ ->
  let cursor = parse_file_into_stream "sample.blob" parser |> tap in
  let part1 () = xprintf "%d" (part1 11 7 cursor) ~expect:(fun () -> {%expect| 12 |}) in
  fork_join_array [| part1 |]
;;

let%expect_test "input" =
  let open! Aoc_std in
  let open Solution in
  run ~timeout:20.
  @@ fun _ ->
  let cursor = parse_file_into_stream "input.blob" parser |> tap in
  let part1 () =
    xprintf "%d" (part1 101 103 cursor) ~expect:(fun () -> {%expect| 228690000 |})
  in
  let part2 () =
    let bots = Parallel_iter.to_list (Parallel_iter.of_cursor cursor) in
    step_until_is_tree 0 101 103 bots (List.length bots) ~expect:(fun () ->
      {%expect|
        After 7093 steps:
        .........................1...........................................................................
        ..............................1......................................................................
        .....................................................................................1.........1.....
        ..............................................1.........................................1............
        .....................................................................................................
        .1.............1.....................................................................................
        .....................................................................................................
        ......1.....1.......................................................1...................1............
        1.........................................................................1..........................
        ..........................................1..........................................................
        .....................................................................................................
        ..............................................................................1................1.....
        ................................1...1...............1..............................1.................
        ....................1................................................................................
        .......................1........................................................1....................
        ...........1...........1.....................1.......................................................
        ...................................................1..........1......................................
        ..................1...........1...................................................................1..
        .....................................................................................................
        .................1...........................1.......................................................
        ................1..1................................1................................................
        .....................................................................................................
        .....................................................................................................
        ............................1.1.....1111111111111111111111111111111..................................
        .1..................................1.............................1..................................
        ....................................1.............................1..................................
        ...1................................1.............................1..........................1.......
        ..........................1.........1.............................1...................1..............
        ....................................1..............1..............1..................................
        ...............................1....1.............111.............1..................................
        ....................................1............11111............1..................................
        ....................................1...........1111111...........1......................1........1..
        ....................................1..........111111111..........1............1................1....
        ....................................1............11111............1........1.........................
        ....................................1...........1111111...........1..................................
        .....................1............1.1..........111111111..........1.1............................1...
        ....................................1.........11111111111.........1..................................
        ....................................1........1111111111111........1..................................
        ....................................1..........111111111..........1.1..................11............
        ....................................1.........11111111111.........1..................................
        ....................................1........1111111111111........1..................................
        ......................1.............1.......111111111111111.......1..................................
        .......1............................1......11111111111111111......1..................................
        ...........1..1.....................1........1111111111111........1................1.................
        ....................................1.......111111111111111.......1...........................1......
        ....................................1......11111111111111111......1.....1.................1..........
        ......1.............................1.....1111111111111111111.....1..........1.......................
        ................1...................1....111111111111111111111....1...................1..............
        ..................................1.1.............111.............1..................................
        ....................................1.............111.............1......1...........................
        ....................................1.............111.............1..................................
        ....................................1.............................1..................................
        ............................1.......1.............................1..................................
        ....................................1.............................1..................................
        ...............1....................1.............................1..............1...................
        ..............1.........1...........1111111111111111111111111111111.....................1............
        ...........................1........................................1................................
        ....................1.....1................1..........................1..............................
        ............................1........................................................................
        ...............................................................................................1.....
        .........................1......................................1....................................
        .........................................................................1...1.......................
        ............................................1........................................................
        .............................................................................1........1..............
        .....................................................................................................
        .....................................................................................................
        ...1............................................1..............1.....................................
        .....................................................................................................
        .....................................................................................................
        ....................................................................................1............1...
        ..................................................................1..................................
        ................................1.......................1............................................
        .....................................................................................................
        ......................1..............................................................................
        ..............................1............1.........................................................
        ..............................................................1......................................
        ................................................................1....................................
        ......................................1............................1....................1............
        .....................................................................................................
        .....................................................................................................
        .........................................................................1....................1......
        ....................................1.......1............1.......1.........................1.........
        .....................................................................................................
        ...................................1................................1................................
        ..........................................................................1..........................
        .....................................................................1.........1.................1...
        ........................................1...........1...................1............................
        .................................................................1....1..............................
        ...........................................1.........................................................
        .....................................................................................................
        .1....1............................................................................1.................
        .........................................................1...........................................
        ..........................................................................................1..........
        ...................................1........................................................1........
        ........................1......................................1..........................1.1........
        .......1..................................................................1.........................1
        .....................................................................................................
        .....................................................................................................
        ..................................................................1................................1.
        .........................................................................1...........................
        ..........................1..........................................................................
        .................................................................1...................................
        ...........1.........................................................................................
        |})
  in
  fork_join_array [| part1; part2 |]
;;
